<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºæ…§èªéŸ³ä»£è¾¦äº‹é …å°åŠ©æ‰‹</title>
    <!-- å·²è‡ªå‹•ç§»é™¤ Google Translate ç›¸é—œ <link> å’Œ <script>ï¼Œé¿å… CSP éŒ¯èª¤ -->
    <style>
        :root {
    /* å³å´æ—¥æ›†æ¬„æ’ç‰ˆä¿®æ­£ */
    .main-layout {
        display: flex;
        flex-direction: row;
        justify-content: flex-start;
        align-items: flex-start;
        gap: 32px;
        max-width: 1200px;
        margin: 0 auto;
        width: 100%;
    }
    .container {
        flex: 1 1 0;
        min-width: 340px;
        max-width: 700px;
    }
    #calendarPanel {
        order: 2;
    }
    --green-bg: #f3f8f3;
    --green-main: #cbe7cb;
    --green-accent: #b7d8b7;
    --green-btn: #b7d8b7;
    --green-btn-hover: #a2c7a2;
    --green-danger: #b7d8b7;
    --green-white: #f8f7f4;
    --green-dark: #2e3d2e;
}
body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: var(--green-bg);
    margin: 0;
    padding: 0;
    color: var(--green-dark);
}
.container {
    max-width: 600px;
    margin: 60px auto;
    background: var(--green-white);
    border-radius: 16px;
    box-shadow: 0 4px 24px rgba(0,0,0,0.10);
    padding: 40px 32px;
    text-align: center;
    color: var(--green-dark);
}
h1, h3, h4, label, select, input, p, span, small, div, ul, li {
    color: var(--green-dark) !important;
}
.btn, .mic-btn {
    display: inline-block;
    margin-top: 24px;
    padding: 12px 32px;
    background: var(--green-btn);
    color: var(--green-dark);
    border: none;
    border-radius: 8px;
    font-size: 1em;
    cursor: pointer;
    transition: background 0.2s, color 0.2s;
    box-shadow: 0 2px 8px #0001;
}
.btn.action, .btn.delete {
    background: var(--green-dark);
    color: #fff;
}
.btn.action:hover, .btn.delete:hover {
    background: #1d261d;
    color: #fff;
}
.btn:hover, .mic-btn:hover {
    background: var(--green-btn-hover);
    color: #fff;
}
.mic-btn {
    margin-left: 12px;
    background: var(--green-main);
    color: var(--green-dark);
}
.mic-btn:hover {
    background: var(--green-accent);
    color: #fff;
}
ul.todo-list li {
    background: var(--green-main);
    margin-bottom: 12px;
    padding: 14px 20px;
    border-radius: 8px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: 0 1px 4px #0001;
    color: var(--green-dark);
}
.done {
    text-decoration: line-through;
    color: #7a8a7a !important;
}
/* æ—¥æ›†æ¬„æ’ç‰ˆä¿®æ­£ */
#calendarPanel {
    background: var(--green-white);
    border-radius: 16px;
    box-shadow: 0 4px 24px #0001;
    padding: 24px 18px;
    color: var(--green-dark);
    position: relative;
    margin-left: 32px;
    margin-top: 60px;
    min-width: 340px;
    max-width: 480px;
    flex: 0 0 440px;
    align-self: flex-start;
    height: fit-content;
}
@media (max-width: 900px) {
    .main-layout {
        flex-direction: column;
        align-items: stretch;
    }
    .container {
        max-width: 100% !important;
    }
    #calendarPanel {
        position: static !important;
        margin-left: 0 !important;
        margin-top: 32px !important;
        max-width: 100% !important;
        min-width: 0 !important;
        width: 100%;
        order: unset;
    }
}
#calendar {
    margin-top: 12px;
}
#calendar table {
    background: var(--green-white);
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 2px 8px #0001;
}
#calendar th {
    background: var(--green-main);
    color: var(--green-dark);
    font-weight: 600;
    padding: 8px 0;
    font-size: 1.1em;
}
#calendar td {
    background: var(--green-bg);
    border: 1px solid var(--green-main);
    min-width: 180px;
    width: 180px;
    padding: 4px 4px;
    font-size: 1.1em;
    vertical-align: top;
    color: var(--green-dark);
}
#calendar ul {
    padding-left: 14px;
    margin: 2px 0 0 0;
    list-style-type: disc;
}
#calendar li {
    font-size: 0.1em !important;
    margin-bottom: 1px;
    background: var(--green-accent);
    border-radius: 7px;
    padding: 2px 6px;
    color: var(--green-dark);
    display: flex;
    align-items: center;
    white-space: normal;
    overflow: visible;
    text-overflow: unset;
    word-break: break-all;
}
#calendar li[style*=\"line-through\"] {
    background: #e0e0e0;
    color: #aaa !important;
}
#calendar .calendar-editable {
    background: transparent;
    border: none;
    outline: none;
    color: var(--green-dark);
}
input[type=\"text\"].calendar-edit-input {
    background: #fff;
    border: 1px solid var(--green-main);
    border-radius: 6px;
    padding: 2px 6px;
    font-size: 1em;
    color: var(--green-dark);
}
#aiResponse, #undoneList, #arduinoStatus, #calendarOptionsModal > div {
    color: var(--green-dark) !important;
}
#arduinoPanel {
    background: var(--green-bg);
    border-radius: 10px;
    box-shadow: 0 2px 8px #0001;
    color: var(--green-dark);
}
#calendarOptionsModal > div {
    background: var(--green-white);
    color: var(--green-dark);
}
#calendarOptionsModal label, #calendarOptionsModal select {
    color: var(--green-dark);
}
#calendarOptionsModal button {
    background: var(--green-main);
    color: var(--green-dark);
}
#calendarOptionsModal button:hover {
    background: var(--green-accent);
}
    </style>
</head>
<body>
    <div class="main-layout">
      <div class="container" style="flex:1 1 600px;min-width:340px;margin:60px 0 0 0;">
        <h1>æ™ºæ…§èªéŸ³ä»£è¾¦äº‹é …å°åŠ©æ‰‹</h1>
        <p>ç”¨èªéŸ³å¿«é€Ÿæ–°å¢ã€åˆ†é¡ã€ç®¡ç†ä½ çš„å¾…è¾¦äº‹é …ï¼</p>
        <div>
            <input type="text" id="taskInput" placeholder="è¼¸å…¥æˆ–èªªå‡ºä½ çš„ä»»å‹™..." style="width:60%;padding:10px;">
            <button class="btn" onclick="addTask()">æ–°å¢ä»»å‹™</button>
            <button class="mic-btn" onclick="startVoiceInput()">ğŸ¤ èªéŸ³è¼¸å…¥</button>
        </div>
        <ul class="todo-list" id="todoList"></ul>
        <div id="aiResponse" style="margin-top:24px;color:#2563eb;"></div>
        <div id="undoneList" style="margin-top:16px;color:#e67e22;"></div>
        <div id="arduinoStatus" style="margin-top:16px;color:#b91c1c;"></div>
        <div id="arduinoPanel" style="margin-top:24px;padding:18px 0;background:#f8fafc;border-radius:8px;box-shadow:0 2px 8px #0001;max-width:400px;margin-left:auto;margin-right:auto;"></div>
      </div>
      <!-- æ—¥æ›†æ¬„ç§»åˆ° main-layout å…§ï¼Œcontainer æ—é‚Š -->
      <div id="calendarPanel" style="position:sticky;top:40px;flex:0 0 440px;min-width:340px;max-width:480px;height:fit-content;background:#fff;border-radius:12px;box-shadow:0 4px 24px #0001;padding:24px 18px;margin:60px 0 0 24px;z-index:1;align-self:flex-start;">
        <h3 style="margin-top:0;color:#2563eb;">ä»»å‹™æ—¥æ›†</h3>
        <!-- <button id="calendarOptionsBtn" class="btn" style="margin-bottom:12px;float:right;padding:6px 18px;font-size:1em;">é¸é …</button> -->
        <div style="clear:both"></div>
        <div id="calendarOptionsModal" style="display:none;position:fixed;z-index:1000;left:0;top:0;width:100vw;height:100vh;background:rgba(0,0,0,0.25);align-items:center;justify-content:center;">
          <div style="background:#fff;padding:32px 24px 24px 24px;border-radius:12px;min-width:320px;max-width:90vw;box-shadow:0 8px 32px #0003;position:relative;">
            <button onclick="closeCalendarOptions()" style="position:absolute;right:12px;top:12px;font-size:1.2em;background:none;border:none;cursor:pointer;">âœ•</button>
            <h4 style="margin-top:0;color:#2563eb;">æ‰¹æ¬¡ç·¨è¼¯æ—¥æ›†ä»»å‹™</h4>
            <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
              <label>å¹´ï¼š
                <select id="calendarOptYear" style="font-size:1em;padding:2px 6px;"></select>
              </label>
              <label>æœˆï¼š
                <select id="calendarOptMonth" style="font-size:1em;padding:2px 6px;"></select>
              </label>
              <label>æ—¥ï¼š
                <select id="calendarOptDay" style="font-size:1em;padding:2px 6px;"></select>
              </label>
              <label>æ™‚ï¼š
                <select id="calendarOptHour" style="font-size:1em;padding:2px 6px;"></select>
              </label>
            </div>
            <div id="calendarOptionsTasks" style="margin-top:16px;"></div>
            <div id="calendarOptActionBtns" style="margin-top:18px;display:none;gap:12px;">
              <button class="btn" id="calendarOptConfirmBtn" style="background:#4f8cff;">ç¢ºèªæ›´æ”¹</button>
              <button class="btn" id="calendarOptCancelBtn" style="background:#aaa;">å–æ¶ˆ</button>
            </div>
            <button class="btn" style="margin-top:18px;background:#4f8cff;" onclick="syncCalendarToMain()">åŒæ­¥ä¸»æ¸…å–®</button>
          </div>
        </div>
        <div id="calendar"></div>
      </div>
    </div>
            <h3 style="margin:0 0 8px 0;color:#2563eb;">Arduino ç‹€æ…‹</h3>
            <div id="arduinoStateText" style="font-size:1.1em;color:#333;">å°šæœªåŒæ­¥</div>
            <button onclick="connectArduino()" style="margin-top:10px;padding:8px 18px;">é€£æ¥ Arduino</button>
        </div>
    </div>

</body>
<script>
// ä»»å‹™è³‡æ–™
let tasks = [];
// æ—¥æ›†è³‡æ–™
let calendarTasks = {};

// ========== ä¸»è¦åŠŸèƒ½å¯¦ä½œ ===========
function addTaskToCalendar(raw, displayText) {
    let dateStr = '';
    let timeStr = '';
    let today = new Date();
    let m = raw.match(/(\d{4})[\/-](\d{1,2})[\/-](\d{1,2})/);
    if (m) {
        dateStr = `${m[1]}-${String(m[2]).padStart(2,'0')}-${String(m[3]).padStart(2,'0')}`;
    } else {
        m = raw.match(/(\d{1,2})[\/-](\d{1,2})/);
        if (m) {
            dateStr = `${today.getFullYear()}-${String(m[1]).padStart(2,'0')}-${String(m[2]).padStart(2,'0')}`;
        } else if (/æ˜å¤©/.test(raw)) {
            let d = new Date(today.getTime() + 86400000);
            dateStr = d.toISOString().slice(0,10);
        } else if (/å¾Œå¤©/.test(raw)) {
            let d = new Date(today.getTime() + 2*86400000);
            dateStr = d.toISOString().slice(0,10);
        } else if (/ä»Šå¤©/.test(raw)) {
            dateStr = today.toISOString().slice(0,10);
        }
    }
    let t = raw.match(/(æ—©ä¸Š|ä¸Šåˆ|ä¸­åˆ|ä¸‹åˆ|æ™šä¸Š)?\s*(\d{1,2})(:|é»|æ™‚)?(\d{1,2})?/);
    if (t && (t[1] || t[2])) {
        timeStr = (t[1] || '') + (t[2] ? t[2] + (t[3] === ':' && t[4] ? ':' + t[4] : 'é»') : '');
        if (t[3] && t[3] !== ':' && t[4]) timeStr += t[4] + 'åˆ†';
    }
    if (dateStr) {
        if (!calendarTasks[dateStr]) calendarTasks[dateStr] = [];
        let calText = '';
        let t = raw.match(/(æ—©ä¸Š|ä¸Šåˆ|ä¸­åˆ|ä¸‹åˆ|æ™šä¸Š)?\s*(\d{1,2})(:|é»|æ™‚)?(\d{1,2})?/);
        let timeStr2 = '';
        if (t && (t[1] || t[2])) {
            timeStr2 = (t[1] || '') + (t[2] ? t[2] + (t[3] === ':' && t[4] ? ':' + t[4] : 'é»') : '');
            if (t[3] && t[3] !== ':' && t[4]) timeStr2 += t[4] + 'åˆ†';
        }
        let mainVerb = '';
        let taskMatch = raw.match(/è¦(.+)/);
        if (taskMatch) {
            mainVerb = taskMatch[1].replace(/[ï¼Œã€‚,.]/g, '').trim();
        } else {
            mainVerb = raw.replace(/(ä»Šå¤©|æ˜å¤©|å¾Œå¤©)?(æ—©ä¸Š|ä¸Šåˆ|ä¸­åˆ|ä¸‹åˆ|æ™šä¸Š)?(\d{1,2})(é»|:|æ™‚)?(\d{1,2})?/, '').replace(/[ï¼Œã€‚,.]/g, '').replace(/è¦$/,'').trim();
        }
        calText = (timeStr2 ? timeStr2 + ' ' : '') + mainVerb;
        calendarTasks[dateStr].push(calText);
        renderCalendar();
    }
}
function renderCalendar() {
    const cal = document.getElementById('calendar');
    let today = new Date();
    let year = today.getFullYear();
    let month = today.getMonth();
    let firstDay = new Date(year, month, 1).getDay();
    let daysInMonth = new Date(year, month + 1, 0).getDate();
    let dayTaskMap = {};
    for (let d in calendarTasks) {
        let dt = new Date(d);
        if (dt.getFullYear() === year && dt.getMonth() === month) {
            let day = dt.getDate();
            dayTaskMap[day] = calendarTasks[d];
        }
    }
    let html = `<table style=\"width:100%;border-collapse:collapse;table-layout:fixed;\"><thead><tr>`;
    const weekDays = ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'];
    for (let w of weekDays) html += `<th style=\"padding:4px;color:#2563eb;\">${w}</th>`;
    html += '</tr></thead><tbody><tr>';
    let col = 0;
    for (let i = 0; i < firstDay; i++) { html += '<td></td>'; col++; }
    for (let d = 1; d <= daysInMonth; d++) {
        let cellTasks = dayTaskMap[d] || [];
        html += `<td style=\"vertical-align:top;min-height:100px;height:100px;padding:8px 4px;border:1px solid #eee;font-size:1.1em;\"><div style=\"font-weight:bold;font-size:1.3em;\">${d}</div>`;
        if (cellTasks.length > 0) {
            html += '<ul style=\"padding-left:14px;margin:2px 0 0 0;list-style-type:disc;\">';
            for (let j = 0; j < cellTasks.length; j++) {
                let t = cellTasks[j];
                let matchedIdx = tasks.findIndex(task => task.text === t);
                let matched = matchedIdx !== -1 ? tasks[matchedIdx] : null;
                html += `<li${matched && matched.done ? ' style=\"text-decoration:line-through;color:#aaa;font-size:0.16em;\"' : ' style=\"font-size:0.16em;\"'}>`;
                html += `<span class='calendar-editable' data-day='${d}' data-idx='${j}' style='cursor:pointer;display:inline-block;width:70%;overflow:hidden;text-overflow:ellipsis;vertical-align:middle;'>${t}</span>`;
// äº‹ä»¶å§”æ´¾ï¼šæ—¥æ›†æ¬„ä»»å‹™å…§å®¹é›™æ“Šå¯ç·¨è¼¯
document.addEventListener('dblclick', function(e) {
    if (e.target.classList && e.target.classList.contains('calendar-editable')) {
        const span = e.target;
        const day = span.getAttribute('data-day');
        const idx = parseInt(span.getAttribute('data-idx'));
        enableCalendarEdit(span, day, idx);
    }
});
// é›™æ“Šå•Ÿç”¨æ—¥æ›†æ¬„ä»»å‹™ç·¨è¼¯
function enableCalendarEdit(span, day, idx) {
    const today = new Date();
    const year = today.getFullYear();
    const month = today.getMonth();
    const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
    const oldVal = calendarTasks[dateStr][idx];
    const input = document.createElement('input');
    input.type = 'text';
    input.value = oldVal;
    input.style.fontSize = '1em';
    input.style.width = '70%';
    input.style.padding = '1px 4px';
    input.onblur = function() {
        finishCalendarEdit(input, span, day, idx);
    };
    input.onkeydown = function(e) {
        if (e.key === 'Enter') input.blur();
    };
    // ä¿ç•™åŸ span ä»¥åˆ©é‚„åŸ
    span.style.display = 'none';
    span.parentNode.insertBefore(input, span);
    input.focus();
    input.select();
}

function finishCalendarEdit(input, span, day, idx) {
    const today = new Date();
    const year = today.getFullYear();
    const month = today.getMonth();
    const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
    const newVal = input.value.trim();
    if (newVal === '') {
        input.remove();
        span.style.display = '';
        return;
    }
    const oldVal = calendarTasks[dateStr][idx];
    calendarTasks[dateStr][idx] = newVal;
    // åŒæ­¥ä¸»æ¸…å–®å…§å®¹
    const taskIdx = tasks.findIndex(task => task.text === oldVal);
    if (taskIdx !== -1) {
        tasks[taskIdx].text = newVal;
        renderTasks();
    }
    // é‚„åŸç‚º span ä¸¦æ›´æ–°å…§å®¹
    span.textContent = newVal;
    input.remove();
    span.style.display = '';
}
                if (matched) {
                  html += ` <button style='margin-left:4px;font-size:0.9em;padding:1px 8px;' onclick='toggleCalendarTaskDone("${d}",${j})'>${matched.done ? 'å¾©åŸ' : 'å®Œæˆ'}</button>`;
                }
                html += `</li>`;
            }
// æ—¥æ›†æ¬„ç›´æ¥ç·¨è¼¯ä»»å‹™å…§å®¹ï¼Œä¸¦åŒæ­¥ä¸»æ¸…å–®
function editCalendarTaskContentByDay(day, idx, newVal) {
    const today = new Date();
    const year = today.getFullYear();
    const month = today.getMonth();
    const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
    if (newVal.trim() === '') return;
    const oldVal = calendarTasks[dateStr][idx];
    calendarTasks[dateStr][idx] = newVal;
    // åŒæ­¥ä¸»æ¸…å–®å…§å®¹
    const taskIdx = tasks.findIndex(task => task.text === oldVal);
    if (taskIdx !== -1) {
        tasks[taskIdx].text = newVal;
        renderTasks();
    }
    renderCalendar();
}
            html += '</ul>';
        }
        html += '</td>';
        col++;
        if (col % 7 === 0 && d !== daysInMonth) html += '</tr><tr>';
    }
// æ—¥æ›†æ¬„åˆ‡æ›å®Œæˆ/å¾©åŸï¼Œä¸¦åŒæ­¥ä¸»æ¸…å–®
function toggleCalendarTaskDone(day, idx) {
    const today = new Date();
    const year = today.getFullYear();
    const month = today.getMonth();
    const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
    const t = calendarTasks[dateStr][idx];
    const taskIdx = tasks.findIndex(task => task.text === t);
    if (taskIdx !== -1) {
        tasks[taskIdx].done = !tasks[taskIdx].done;
        renderTasks();
        renderCalendar();
        notifyArduino();
    }
}
    while (col % 7 !== 0) { html += '<td></td>'; col++; }
    html += '</tr></tbody></table>';
    cal.innerHTML = html;
}
function renderTasks() {
    const list = document.getElementById('todoList');
    list.innerHTML = '';
    tasks.forEach((task, idx) => {
        const li = document.createElement('li');
        li.innerHTML = `<span class=\"${task.done ? 'done' : ''}\">${task.text} <small>(${task.category})</small></span>` +
            `<span style='float:right;display:flex;gap:0;'>` +
            `<button class=\"btn\" style=\"padding:4px 12px;font-size:0.9em;margin-left:0;\" onclick=\"toggleDone(${idx})\">${task.done ? 'å¾©åŸ' : 'å®Œæˆ'}</button>` +
            `<button class=\"btn\" style=\"padding:4px 12px;font-size:0.9em;background:#e53e3e;margin-left:0;\" onclick=\"deleteTask(${idx})\">åˆªé™¤</button>` +
            `</span>`;
        list.appendChild(li);
    });
}
function deleteTask(idx) {
    if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™å€‹ä»»å‹™å—ï¼Ÿ')) return;
    const deleted = tasks[idx].text;
    let main = deleted;
    let time = '';
    let m = deleted.match(/(.+?)\s*([ï¼ˆ(][^ï¼‰)]*[)ï¼‰])?$/);
    if (m) {
        main = m[1].trim();
        if (m[2]) time = m[2].replace(/[ï¼ˆï¼‰()]/g, '').trim();
    }
    for (let date in calendarTasks) {
        calendarTasks[date] = calendarTasks[date].filter(t => {
            if (t === deleted) return false;
            let tNorm = t.replace(/[ï¼ˆï¼‰()]/g, '').replace(/\s+/g, '');
            let mainNorm = main.replace(/[ï¼ˆï¼‰()]/g, '').replace(/\s+/g, '');
            if (tNorm === mainNorm) return false;
            if (tNorm.includes(mainNorm) || mainNorm.includes(tNorm)) return false;
            if (time) {
                let timeNorm = time.replace(/[ï¼ˆï¼‰()]/g, '').replace(/\s+/g, '');
                if (tNorm.includes(mainNorm+timeNorm) || (mainNorm+timeNorm).includes(tNorm)) return false;
            }
            return true;
        });
        if (calendarTasks[date].length === 0) delete calendarTasks[date];
    }
    tasks.splice(idx, 1);
    renderTasks();
    renderCalendar();
    notifyArduino();
}
function toggleDone(idx) {
    tasks[idx].done = !tasks[idx].done;
    renderTasks();
    notifyArduino();
}
function startVoiceInput() {
    if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
        alert('æ­¤ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³è¾¨è­˜');
        return;
    }
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    const recognition = new SpeechRecognition();
    recognition.lang = 'zh-TW';
    recognition.onresult = function(event) {
        const transcript = event.results[0][0].transcript;
        document.getElementById('taskInput').value = transcript;
        addTask(transcript);
    };
    recognition.start();
}
async function callAI(text) {
    const res = await fetch('http://localhost:5000/api/ai', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ text })
    });
    return await res.json();
}
function notifyArduino() {
    let unfinished = tasks.filter(t => !t.done).length;
    let status = '';
    if (tasks.length === 0) {
        status = 'ğŸ”´ ç›®å‰ç„¡æœªå®Œæˆçš„ä»»å‹™';
    } else if (unfinished === 0) {
        status = 'ğŸŸ¢ æ‰€æœ‰ä»»å‹™å·²å®Œæˆï¼Œç¶ ç‡ˆ';
    } else {
        status = 'ğŸ”´ å°šæœ‰ ' + unfinished + ' é …æœªå®Œæˆï¼Œç´…ç‡ˆ';
    }
    document.getElementById('arduinoStatus').innerText = status;
    if (arduinoWriter) {
        if (tasks.length === 0) {
            sendToArduino('G');
            document.getElementById('arduinoStateText').innerText = 'ç¶ ç‡ˆï¼šç›®å‰ç„¡æœªå®Œæˆçš„ä»»å‹™';
        } else if (unfinished === 0) {
            sendToArduino('G');
            document.getElementById('arduinoStateText').innerText = 'ç¶ ç‡ˆï¼šæ‰€æœ‰ä»»å‹™å·²å®Œæˆ';
        } else {
            sendToArduino('R');
            document.getElementById('arduinoStateText').innerText = `ç´…ç‡ˆï¼šå°šæœ‰ ${unfinished} é …æœªå®Œæˆ`;
        }
    } else {
        document.getElementById('arduinoStateText').innerText = 'å°šæœªé€£æ¥ Arduino';
    }
}
function openCalendarOptions() {
    document.getElementById('calendarOptionsModal').style.display = 'flex';
    const now = new Date();
    const ySel = document.getElementById('calendarOptYear');
    const mSel = document.getElementById('calendarOptMonth');
    const dSel = document.getElementById('calendarOptDay');
    const hSel = document.getElementById('calendarOptHour');
    ySel.innerHTML = '';
    for(let y=now.getFullYear()-2;y<=now.getFullYear()+2;y++) ySel.innerHTML += `<option value="${y}"${y===now.getFullYear()?' selected':''}>${y}</option>`;
    mSel.innerHTML = '';
    for(let m=1;m<=12;m++) mSel.innerHTML += `<option value="${m.toString().padStart(2,'0')}"${m===now.getMonth()+1?' selected':''}>${m}</option>`;
    updateDayOptions();
    hSel.innerHTML = '<option value="">--</option>';
    for(let h=0;h<24;h++) hSel.innerHTML += `<option value="${h.toString().padStart(2,'0')}">${h.toString().padStart(2,'0')}</option>`;
    ySel.onchange = mSel.onchange = function(){ updateDayOptions(); showOptActionBtns(); };
    dSel.onchange = hSel.onchange = showOptActionBtns;
    function updateDayOptions() {
        const y = parseInt(ySel.value), m = parseInt(mSel.value);
        const days = new Date(y, m, 0).getDate();
        dSel.innerHTML = '';
        for(let d=1;d<=days;d++) dSel.innerHTML += `<option value="${d.toString().padStart(2,'0')}"${d===now.getDate()?' selected':''}>${d}</option>`;
    }
    function showOptActionBtns() {
        document.getElementById('calendarOptActionBtns').style.display = 'flex';
        renderCalendarOptionsTasks(getOptDateStr());
    }
    function getOptDateStr() {
        return ySel.value+'-'+mSel.value+'-'+dSel.value;
    }
    renderCalendarOptionsTasks(getOptDateStr());
    document.getElementById('calendarOptActionBtns').style.display = 'none';
    document.getElementById('calendarOptConfirmBtn').onclick = function(){ closeCalendarOptions(); };
    document.getElementById('calendarOptCancelBtn').onclick = function(){ closeCalendarOptions(); };
}
function renderCalendarOptionsTasks(dateStr) {
    const box = document.getElementById('calendarOptionsTasks');
    if (!calendarTasks[dateStr] || calendarTasks[dateStr].length === 0) {
        box.innerHTML = '<span style="color:#aaa;">æ­¤æ—¥æš«ç„¡ä»»å‹™</span>';
        return;
    }
    box.innerHTML = '';
    calendarTasks[dateStr].forEach((t, idx) => {
        box.innerHTML += `<div style="margin-bottom:8px;display:flex;align-items:center;gap:8px;">
          <input type="text" value="${t}" style="flex:1;padding:4px 8px;font-size:1em;" onchange="editCalendarTaskContent('${dateStr}',${idx},this.value)">
          <button style="background:#e53e3e;color:#fff;padding:2px 10px;border:none;border-radius:4px;" onclick="deleteCalendarTask('${dateStr}',${idx})">åˆªé™¤</button>
        </div>`;
    });
}
function editCalendarTaskContent(dateStr, idx, newVal) {
    if (newVal.trim() === '') return;
    calendarTasks[dateStr][idx] = newVal;
    renderCalendar();
}
function deleteCalendarTask(dateStr, idx) {
    if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤ä»»å‹™ï¼Ÿ')) return;
    calendarTasks[dateStr].splice(idx,1);
    if (calendarTasks[dateStr].length === 0) delete calendarTasks[dateStr];
    renderCalendarOptionsTasks(dateStr);
    renderCalendar();
}
function syncCalendarToMain() {
    tasks.forEach(task => {
        let raw = task.text;
        let dateStr = '';
        let today = new Date();
        let m = raw.match(/(\d{4})[\/-](\d{1,2})[\/-](\d{1,2})/);
        if (m) {
          dateStr = `${m[1]}-${String(m[2]).padStart(2,'0')}-${String(m[3]).padStart(2,'0')}`;
        } else {
          m = raw.match(/(\d{1,2})[\/-](\d{1,2})/);
          if (m) {
            dateStr = `${today.getFullYear()}-${String(m[1]).padStart(2,'0')}-${String(m[2]).padStart(2,'0')}`;
          } else if (/æ˜å¤©/.test(raw)) {
            let d = new Date(today.getTime() + 86400000);
            dateStr = d.toISOString().slice(0,10);
          } else if (/å¾Œå¤©/.test(raw)) {
            let d = new Date(today.getTime() + 2*86400000);
            dateStr = d.toISOString().slice(0,10);
          } else if (/ä»Šå¤©/.test(raw)) {
            dateStr = today.toISOString().slice(0,10);
          }
        }
        if (dateStr) {
          if (!calendarTasks[dateStr]) calendarTasks[dateStr] = [];
          if (!calendarTasks[dateStr].includes(task.text)) calendarTasks[dateStr].push(task.text);
        }
    });
    renderCalendar();
    alert('å·²åŒæ­¥ä¸»æ¸…å–®ä»»å‹™åˆ°æ—¥æ›†ï¼');
}

// æ–°å¢ä»»å‹™
function addTask(text) {
    const input = document.getElementById('taskInput');
    const value = text || input.value.trim();
    if (!value) return;
    // è‹¥è¼¸å…¥æœ‰ã€Œå·²å®Œæˆã€ç­‰é—œéµå­—ï¼Œå˜—è©¦è‡ªå‹•å®Œæˆç¾æœ‰ä»»å‹™
    if (/å·²å®Œæˆ|å®Œæˆ|done|å·²åš|å·²è¾¦|å·²è§£æ±º|å·²è™•ç†/i.test(value)) {
        // æ“·å–æ™‚é–“ç‰‡æ®µ
        const timePattern = /(ä»Šå¤©|æ˜å¤©|å¾Œå¤©)?(æ—©ä¸Š|ä¸Šåˆ|ä¸­åˆ|ä¸‹åˆ|æ™šä¸Š)?(\d{1,2})(é»|:|æ™‚)?(\d{1,2})?/;
        let timeInfo = '';
        let mainTask = value;
        let cutIdx = value.indexOf('è¦');
        let beforeYao = cutIdx > 0 ? value.slice(0, cutIdx) : '';
        let m = beforeYao.match(timePattern);
        if (m) {
            let when = (m[1] || '') + (m[2] || '');
            let hour = m[3] || '';
            let min = m[5] || '';
            timeInfo = when + (hour ? hour + 'é»' : '') + (min ? (':' + min) : '');
        }
        // ä¸»å‹•è©
        let mainVerb = '';
        let taskMatch = value.match(/è¦(.+)/);
        if (taskMatch) {
            mainVerb = taskMatch[1].replace(/[ï¼Œã€‚,.å·²å®Œæˆå®Œæˆdoneå·²åšå·²è¾¦å·²è§£æ±ºå·²è™•ç†]/gi, '').trim();
        } else {
            mainVerb = value.replace(timePattern, '').replace(/[ï¼Œã€‚,.å·²å®Œæˆå®Œæˆdoneå·²åšå·²è¾¦å·²è§£æ±ºå·²è™•ç†]/gi, '').replace(/è¦$/,'').trim();
        }
        let targetText = (timeInfo ? timeInfo + ' ' : '') + mainVerb;
        // åœ¨ tasks ä¸­å°‹æ‰¾æœ€æ¥è¿‘çš„ä»»å‹™
        let found = false;
        for (let i = 0; i < tasks.length; i++) {
            // æ¯”å°å¿½ç•¥ç©ºç™½
            if (tasks[i].text.replace(/\s+/g,'') === targetText.replace(/\s+/g,'')) {
                tasks[i].done = true;
                found = true;
            }
        }
        renderTasks();
        notifyArduino();
        document.getElementById('aiResponse').innerText = found ? 'âœ… å·²è‡ªå‹•æ¨™è¨˜å®Œæˆï¼š' + targetText : 'âš ï¸ æ‰¾ä¸åˆ°å°æ‡‰ä»»å‹™ï¼š' + targetText;
        return;
    }
    // å‘¼å«AI APIåˆ¤æ–·é‡è¤‡ã€åˆ†é¡
    callAI(value).then(aiResult => {
        // æŸ¥è©¢æœªå®Œæˆäº‹é …
        if (aiResult.category === 'æŸ¥è©¢') {
            const undoneDiv = document.getElementById('undoneList');
            const undoneTasks = tasks.filter(t => !t.done);
            let speakText = '';
            if (tasks.length === 0) {
                document.getElementById('aiResponse').innerText = 'ğŸ‰ ç›®å‰æ²’æœ‰æœªå®Œæˆçš„äº‹é …ï¼';
                undoneDiv.innerText = '';
                speakText = 'ç›®å‰æ²’æœ‰æœªå®Œæˆçš„äº‹é …ã€‚';
            } else if (undoneTasks.length > 0) {
                document.getElementById('aiResponse').innerText = 'æœªå®Œæˆäº‹é …æŸ¥è©¢çµæœï¼š';
                undoneDiv.innerHTML = '<ul style="padding-left:20px;">' + undoneTasks.map((t,i)=>`<li>${i+1}. ${t.text}</li>`).join('') + '</ul>';
                speakText = 'ä½ é‚„æœ‰' + undoneTasks.length + 'é …æœªå®Œæˆçš„äº‹é …ï¼š' + undoneTasks.map((t,i)=>`ç¬¬${i+1}é …ï¼Œ${t.text}`).join('ï¼Œ');
            } else {
                document.getElementById('aiResponse').innerText = 'æœªå®Œæˆäº‹é …æŸ¥è©¢çµæœï¼š';
                undoneDiv.innerHTML = '<span>ï¼ˆç›®å‰æ‰€æœ‰ä»»å‹™éƒ½å·²å®Œæˆï¼‰</span>';
                speakText = 'æ‰€æœ‰ä»»å‹™éƒ½å·²å®Œæˆã€‚';
            }
            // èªéŸ³å›è¦†
            if ('speechSynthesis' in window) {
                const utter = new SpeechSynthesisUtterance(speakText);
                utter.lang = 'zh-TW';
                window.speechSynthesis.speak(utter);
            }
            return;
        }
        if (aiResult.duplicate) {
            document.getElementById('aiResponse').innerText = 'âš ï¸ å·²æœ‰ç›¸ä¼¼ä»»å‹™ï¼šã€Œ' + aiResult.similar + 'ã€';
            return;
        }
        // æ™‚é–“åˆ†é¡ï¼ˆæœ€ç©©å®šï¼šç›´æ¥åœ¨ã€Œè¦ã€å‰æ‰¾æ™‚é–“ï¼‰
        let timeInfo = '';
        let mainTask = value;
        const timeTaskPattern = /è¦(.+)/;
        let cutIdx = value.indexOf('è¦');
        let beforeYao = cutIdx > 0 ? value.slice(0, cutIdx) : '';
        // åªè¦ beforeYao è£¡æœ‰ã€Œ(ä»Šå¤©|æ˜å¤©|å¾Œå¤©)?(æ—©ä¸Š|ä¸Šåˆ|ä¸­åˆ|ä¸‹åˆ|æ™šä¸Š)?(\d{1,2})é»?ã€å°±æ“·å–
        const timePattern = /(ä»Šå¤©|æ˜å¤©|å¾Œå¤©)?(æ—©ä¸Š|ä¸Šåˆ|ä¸­åˆ|ä¸‹åˆ|æ™šä¸Š)?(\d{1,2})(é»|:|æ™‚)?(\d{1,2})?/;
        let m = beforeYao.match(timePattern);
        if (m) {
            let when = (m[1] || '') + (m[2] || '');
            let hour = m[3] || '';
            let min = m[5] || '';
            timeInfo = when + (hour ? hour + 'é»' : '') + (min ? (':' + min) : '');
        }
        let taskMatch = value.match(timeTaskPattern);
        if (taskMatch) {
            mainTask = taskMatch[1].replace(/[ï¼Œã€‚,.]/g, '').trim();
        } else {
            mainTask = value.replace(timePattern, '').replace(/[ï¼Œã€‚,.]/g, '').replace(/è¦$/,'').trim();
        }
        // é¡¯ç¤ºæ ¼å¼ï¼šæ™‚é–“ç‰‡æ®µ+ä¸»å‹•è©
        let displayText = mainTask;
        if (timeInfo) {
            // é¿å…é‡è¤‡æ™‚é–“ç‰‡æ®µ
            if (!mainTask.startsWith(timeInfo)) {
                displayText = `${timeInfo} ${mainTask}`;
            } else {
                displayText = mainTask;
            }
        }
        // åˆ¤æ–·æ˜¯å¦æœ‰ã€Œå·²å®Œæˆã€æˆ–ã€Œå®Œæˆã€ç­‰é—œéµå­—
        let isDone = /å·²å®Œæˆ|å®Œæˆ|done|å·²åš|å·²è¾¦|å·²è§£æ±º|å·²è™•ç†/i.test(value);
        tasks.push({ text: displayText, category: aiResult.category, done: isDone });
        addTaskToCalendar(value, displayText);
        renderTasks();
        input.value = '';
        document.getElementById('aiResponse').innerText = 'âœ… å·²æ–°å¢ä»»å‹™ï¼Œåˆ†é¡ç‚ºï¼š' + aiResult.category + (isDone ? 'ï¼ˆå·²è‡ªå‹•æ¨™è¨˜å®Œæˆï¼‰' : '');
        notifyArduino();
    }).catch(err => {
        // å®¹éŒ¯ï¼šAI API å¤±æ•—æ™‚ä¹Ÿèƒ½æ–°å¢
        let mainTask = value;
        let displayText = value;
        tasks.push({ text: displayText, category: 'å…¶ä»–', done: false });
        addTaskToCalendar(value, displayText);
        renderTasks();
        input.value = '';
        document.getElementById('aiResponse').innerText = 'âš ï¸ AI åˆ†æå¤±æ•—ï¼Œå·²ç›´æ¥æ–°å¢ä»»å‹™';
        notifyArduino();
    });
}

// (å·²ç§»é™¤é‡è¤‡ç©ºæ®¼å‡½å¼)
let arduinoPort;
let arduinoWriter;
async function connectArduino() {
    if ('serial' in navigator) {
        try {
            arduinoPort = await navigator.serial.requestPort();
            await arduinoPort.open({ baudRate: 9600 });
            arduinoWriter = arduinoPort.writable.getWriter();
            document.getElementById('arduinoStateText').innerText = 'å·²é€£æ¥ Arduino';
        } catch (e) {
            document.getElementById('arduinoStateText').innerText = 'é€£æ¥å¤±æ•—: ' + e;
        }
    } else {
        alert('ä½ çš„ç€è¦½å™¨ä¸æ”¯æ´ Web Serial APIï¼Œè«‹ç”¨ Chrome/Edgeã€‚');
    }
}
async function sendToArduino(cmd) {
    if (arduinoWriter) {
        const data = new TextEncoder().encode(cmd);
        await arduinoWriter.write(data);
    }
}
// (å·²ç§»é™¤é‡è¤‡ç©ºæ®¼å‡½å¼)
function closeCalendarOptions() {
    document.getElementById('calendarOptionsModal').style.display = 'none';
}
// (å·²ç§»é™¤é‡è¤‡ç©ºæ®¼å‡½å¼)
// é é¢è¼‰å…¥æ™‚æ¸²æŸ“
renderTasks();
renderCalendar();
</script>
</html>
